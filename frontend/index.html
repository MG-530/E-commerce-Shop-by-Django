<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Store</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="nav-brand">
                <h1>ShopHub</h1>
            </div>
            <nav class="nav-menu">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="cart.html">Cart (<span id="cart-count">0</span>)</a></li>
                    <li><a href="orders.html">Orders</a></li>
                    <li><a href="support.html">Support</a></li>
                    <li id="auth-menu">
                        <a href="login.html" id="login-link">Login</a>
                        <a href="#" id="logout-link" style="display: none;">Logout</a>
                    </li>
                </ul>
            </nav>
            <div class="mobile-menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <section class="hero">
                <h2>Welcome to ShopHub</h2>
                <p>Discover amazing products at great prices</p>
            </section>

            <section class="filters">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="Search products...">
                    <button id="search-btn">Search</button>
                </div>
                <div class="filter-options">
                    <select id="category-filter">
                        <option value="">All Categories</option>
                    </select>
                    <select id="sort-filter">
                        <option value="">Sort by</option>
                        <option value="price_asc">Price: Low to High</option>
                        <option value="price_desc">Price: High to Low</option>
                        <option value="name_asc">Name: A to Z</option>
                        <option value="name_desc">Name: Z to A</option>
                    </select>
                </div>
            </section>

            <section class="products">
                <div class="loading" id="loading">Loading products...</div>
                <div class="products-grid" id="products-grid">
                    <!-- Products will be loaded here -->
                </div>
                <div class="pagination" id="pagination">
                    <!-- Pagination will be loaded here -->
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 ShopHub. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cart.js"></script>
    <script>
        // Initialize the home page
        document.addEventListener('DOMContentLoaded', function() {
            initAuth();
            loadCategories();
            loadProducts();
            updateCartCount();
            
            // Search functionality
            document.getElementById('search-btn').addEventListener('click', handleSearch);
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
            
            // Filter functionality
            document.getElementById('category-filter').addEventListener('change', handleFilter);
            document.getElementById('sort-filter').addEventListener('change', handleFilter);
            
            // Mobile menu toggle
            document.querySelector('.mobile-menu-toggle').addEventListener('click', function() {
                document.querySelector('.nav-menu').classList.toggle('active');
            });
        });

        async function loadCategories() {
            try {
                const categories = await apiCall('/api/catalog/categories/');
                const categoryFilter = document.getElementById('category-filter');
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categoryFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadProducts(page = 1, search = '', category = '', sort = '') {
            try {
                document.getElementById('loading').style.display = 'block';
                
                let url = `/api/catalog/products/?page=${page}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (category) url += `&category=${category}`;
                if (sort) {
                    const [field, direction] = sort.split('_');
                    url += `&ordering=${direction === 'desc' ? '-' : ''}${field}`;
                }
                
                const response = await apiCall(url);
                displayProducts(response);
                displayPagination(response);
                
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('loading').textContent = 'Error loading products';
            }
        }

        function displayProducts(products) {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="${product.image || 'images/placeholder.jpg'}" alt="${product.product_name}" loading="lazy">
                        <div class="product-overlay">
                            <button class="btn-quick-view" onclick="viewProduct(${product.id})">Quick View</button>
                        </div>
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${product.product_name}</h3>
                        <p class="product-description">${product.description.substring(0, 100)}...</p>
                        <div class="product-price">${product.price} تومان</div>
                        <div class="product-actions">
                            <button class="btn-add-cart" onclick="addToCart(${product.id}, '${product.product_name}', ${product.price})">
                                Add to Cart
                            </button>
                            <button class="btn-wishlist" onclick="addToWishlist(${product.id})">♡</button>
                        </div>
                    </div>
                `;
                grid.appendChild(productCard);
            });
        }


        function displayPagination(response) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (response.previous || response.next) {
                const paginationDiv = document.createElement('div');
                paginationDiv.className = 'pagination-controls';
                
                if (response.previous) {
                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = 'Previous';
                    prevBtn.onclick = () => loadProducts(getCurrentPage() - 1, getCurrentSearch(), getCurrentCategory(), getCurrentSort());
                    paginationDiv.appendChild(prevBtn);
                }
                
                if (response.next) {
                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = 'Next';
                    nextBtn.onclick = () => loadProducts(getCurrentPage() + 1, getCurrentSearch(), getCurrentCategory(), getCurrentSort());
                    paginationDiv.appendChild(nextBtn);
                }
                
                pagination.appendChild(paginationDiv);
            }
        }

        function handleSearch() {
            const search = document.getElementById('search-input').value;
            const category = document.getElementById('category-filter').value;
            const sort = document.getElementById('sort-filter').value;
            loadProducts(1, search, category, sort);
        }

        function handleFilter() {
            const search = document.getElementById('search-input').value;
            const category = document.getElementById('category-filter').value;
            const sort = document.getElementById('sort-filter').value;
            loadProducts(1, search, category, sort);
        }

        function getCurrentPage() {
            return 1; // Simplified for now
        }

        function getCurrentSearch() {
            return document.getElementById('search-input').value;
        }

        function getCurrentCategory() {
            return document.getElementById('category-filter').value;
        }

        function getCurrentSort() {
            return document.getElementById('sort-filter').value;
        }

        function viewProduct(productId) {
            window.location.href = `product.html?id=${productId}`;
        }

        async function addToWishlist(productId) {
            if (!isAuthenticated()) {
                alert('Please login to add items to wishlist');
                return;
            }
            
            try {
                await apiCall('/api/wishlist/', {
                    method: 'POST',
                    body: JSON.stringify({ product: productId })
                });
                alert('Added to wishlist!');
            } catch (error) {
                console.error('Error adding to wishlist:', error);
                alert('Error adding to wishlist');
            }
        }
    </script>
</body>
</html>

